<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS La Cabaña | Enterprise System V6.2 (Mobile Fix + Audio)</title>

    <!-- 1. DEPENDENCIAS EXTERNAS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fuentes modernas para mejor legibilidad -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Iconos FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Tailwind CSS Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Motores PDF (Reportes) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Configuración Visual / Tailwind Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', 'sans-serif'],     
                        display: ['"Outfit"', 'sans-serif'], 
                    },
                    colors: {
                        brand: {
                            base: '#F8FAFC', // Fondo más claro
                            dark: '#0F172A', // Slate 900
                            accent: '#F97316', // Orange 500
                            hover: '#EA580C', // Orange 600
                            success: '#10B981', // Emerald 500
                            danger: '#EF4444', 
                            purple: '#8B5CF6',
                            blue: '#3B82F6',
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.1)',
                        'card': '0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.06)',
                        'card-hover': '0 4px 20px rgba(0,0,0,0.12), 0 8px 32px rgba(0,0,0,0.08)',
                        'floating': '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                        'glow-orange': '0 0 20px rgba(249, 115, 22, 0.4)',
                        'glow-green': '0 0 20px rgba(16, 185, 129, 0.4)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'in': 'fadeIn 0.3s ease-out forwards',
                        'up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-urgent': 'pulseRed 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                        'shake': 'shake 0.5s ease-in-out',
                        'glow': 'glow 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { from: { opacity: 0 }, to: { opacity: 1 } },
                        slideUp: { from: { opacity: 0, transform: 'translateY(16px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        scaleIn: { from: { opacity: 0, transform: 'scale(0.95)' }, to: { opacity: 1, transform: 'scale(1)' } },
                        shake: { '0%, 100%': { transform: 'translateX(0)' }, '25%': { transform: 'translateX(-4px)' }, '75%': { transform: 'translateX(4px)' } },
                        glow: { '0%, 100%': { boxShadow: '0 0 5px rgba(249, 115, 22, 0.5)' }, '50%': { boxShadow: '0 0 20px rgba(249, 115, 22, 0.8)' } },
                        pulseRed: {
                            '0%, 100%': { opacity: 1, borderColor: '#ef4444', boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' },
                            '50%': { opacity: .9, borderColor: '#f87171', boxShadow: '0 0 0 12px rgba(239, 68, 68, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS CRITICO - DISEÑO MODERNO 2026 */
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none;
        }
        
        /* Ocultar Scrollbars pero permitir scroll */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilo para el scroll interno - más sutil */
        .inner-scroll::-webkit-scrollbar { width: 3px; }
        .inner-scroll::-webkit-scrollbar-track { background: transparent; }
        .inner-scroll::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.15); border-radius: 10px; }
        .inner-scroll::-webkit-scrollbar-thumb:hover { background-color: rgba(0,0,0,0.25); }

        .sticky-nav {
            position: sticky; top: 0; z-index: 40;
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.04);
        }

        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .safe-top { padding-top: env(safe-area-inset-top, 0px); }
        
        /* Efecto táctil mejorado */
        .tap-effect { transition: transform 0.15s ease, opacity 0.15s ease; }
        .tap-effect:active { transform: scale(0.96); opacity: 0.85; }
        
        /* Cards con efecto glass */
        .glass-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
        }
        
        /* Gradiente animado para botones principales */
        .btn-gradient {
            background: linear-gradient(135deg, #F97316 0%, #EA580C 50%, #F97316 100%);
            background-size: 200% 200%;
            transition: all 0.3s ease;
        }
        .btn-gradient:hover { background-position: 100% 100%; }
        
        /* Efecto de brillo en hover */
        .shine-effect { position: relative; overflow: hidden; }
        .shine-effect::after {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            transform: rotate(30deg) translateX(-100%);
            transition: transform 0.6s ease;
        }
        .shine-effect:hover::after { transform: rotate(30deg) translateX(100%); }

        /* Clases Avanzadas para estados visuales del KDS */
        .kds-card-base { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-width: 3px; }
        
        /* ESTADO 1: FRESCO (< 10 min) - Diseño oscuro elegante */
        .state-fresh { border-color: transparent; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.15); }
        .state-fresh .kds-header { 
            background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%); 
            color: white; 
        }
        .state-fresh .kds-timer-badge { 
            background: rgba(74, 222, 128, 0.2); 
            color: #4ade80; 
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        /* ESTADO 2: ALERTA (10 - 20 min) - Naranja vibrante */
        .state-warning { 
            border-color: #F59E0B; 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.3);
        } 
        .state-warning .kds-header { 
            background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%); 
            color: #78350F; 
        }
        .state-warning .kds-timer-badge { 
            background: rgba(255,255,255,0.9); 
            color: #B45309; 
            font-weight: 900; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* ESTADO 3: CRITICO (> 20 min) - Rojo pulsante */
        .state-critical { 
            animation: pulseRed 1.5s infinite; 
            border-color: #EF4444; 
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4);
        }
        .state-critical .kds-header { 
            background: linear-gradient(135deg, #F87171 0%, #DC2626 100%); 
            color: white; 
        } 
        .state-critical .kds-timer-badge { 
            background: white; 
            color: #DC2626; 
            font-weight: 900; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            animation: shake 0.5s ease-in-out infinite;
        }
        
        /* Mejoras mobile para menú de platillos */
        @media (max-width: 768px) {
            .menu-item-card {
                min-height: 100px !important;
                padding: 12px !important;
            }
            .menu-item-card .item-price {
                font-size: 1.1rem !important;
            }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-slate-800 bg-brand-base">

    <!-- 0. PANTALLA CARGA (SPLASH SCREEN) -->
    <div id="app-loader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-all duration-700">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
            <div class="absolute inset-0 rounded-full border-4 border-brand-accent border-t-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-slate-300 text-2xl"><i class="fa-solid fa-utensils"></i></div>
        </div>
        <h1 class="text-3xl font-display font-black text-slate-900 tracking-tight">La Cabaña</h1>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mt-2">Enterprise POS V6.2</p>
    </div>

    <!-- 0.5 CONTENEDOR DE NOTIFICACIONES TOAST -->
    <div id="toast-container" class="fixed top-4 right-4 z-[120] flex flex-col gap-2 w-full max-w-sm px-4 md:px-0 pointer-events-none"></div>

    <!-- 1. HEADER SUPERIOR - MODERNO -->
    <header class="flex-none h-14 md:h-16 bg-white/80 backdrop-blur-xl border-b border-slate-200/50 flex items-center justify-between px-4 lg:px-8 z-50 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 text-white flex items-center justify-center shadow-lg shadow-orange-500/30 shine-effect">
                <i class="fa-solid fa-fire-burner text-lg"></i>
            </div>
            <div class="leading-none">
                <h2 class="font-display font-bold text-base md:text-lg text-slate-800">La Cabaña</h2>
                <span id="txt-role" class="text-[8px] md:text-[9px] font-black uppercase text-brand-accent tracking-widest">Iniciando...</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Indicador de conexión Firebase -->
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-50 border border-slate-200">
                <div id="indicator-status" class="w-2 h-2 rounded-full bg-red-400 animate-pulse" title="Estado de conexión"></div>
                <span class="text-[10px] font-semibold text-slate-500 hidden md:inline">SYNC</span>
            </div>
            <!-- Botón de Sincronización Manual -->
            <button onclick="window.location.reload()" class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-700 hover:bg-slate-200 transition-all tap-effect border border-slate-200/50" title="Sincronizar Datos">
                <i class="fa-solid fa-arrows-rotate text-sm"></i>
            </button>
        </div>
    </header>

    <!-- 2. AREA PRINCIPAL -->
    <main class="flex-1 relative overflow-hidden bg-brand-base">
        
        <!-- VISTA 0: SELECTOR ROL - DISEÑO PREMIUM -->
        <div id="v-role" class="absolute inset-0 z-40 flex flex-col items-center justify-center p-4 md:p-6 bg-gradient-to-br from-slate-50 via-white to-orange-50/30">
            <div class="w-full max-w-5xl animate-up">
                <!-- Logo y Título -->
                <div class="text-center mb-8 md:mb-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 md:w-20 md:h-20 rounded-3xl bg-gradient-to-br from-orange-500 to-red-500 text-white text-2xl md:text-3xl mb-4 shadow-xl shadow-orange-500/30">
                        <i class="fa-solid fa-fire-burner"></i>
                    </div>
                    <h2 class="text-2xl md:text-4xl font-display font-black text-slate-900 mb-1">La Cabaña</h2>
                    <p class="text-sm md:text-base text-slate-400 font-medium">Sistema POS • Selecciona tu estación</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <!-- MESERO -->
                    <button onclick="APP.setRole('mesero')" class="group relative bg-white hover:-translate-y-1 md:hover:-translate-y-2 hover:shadow-card-hover transition-all duration-300 p-6 md:p-8 rounded-3xl border-2 border-transparent hover:border-orange-400 flex flex-col items-start overflow-hidden shadow-card tap-effect">
                        <div class="absolute inset-0 bg-gradient-to-br from-orange-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-br from-orange-100 to-orange-50 text-orange-500 rounded-2xl flex items-center justify-center text-xl md:text-2xl transition-all group-hover:scale-110 group-hover:shadow-lg group-hover:shadow-orange-500/20">
                            <i class="fa-solid fa-mobile-screen-button"></i>
                        </div>
                        <div class="relative z-10 text-left mt-4 md:mt-6">
                            <h3 class="font-display font-bold text-xl md:text-2xl text-slate-800 group-hover:text-orange-600 transition-colors">Mesero</h3>
                            <p class="text-xs md:text-sm text-slate-400 mt-1">Tomar pedidos</p>
                        </div>
                        <div class="absolute bottom-4 right-4 w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                            <i class="fa-solid fa-arrow-right text-sm"></i>
                        </div>
                    </button>
                    
                    <!-- COCINA (KDS) -->
                    <button onclick="APP.setRole('cocina')" class="group relative bg-gradient-to-br from-slate-900 to-slate-800 hover:-translate-y-1 md:hover:-translate-y-2 hover:shadow-floating transition-all duration-300 p-6 md:p-8 rounded-3xl border-2 border-slate-700 hover:border-slate-600 flex flex-col items-start overflow-hidden shadow-xl tap-effect">
                        <div class="absolute right-[-30px] top-[-30px] text-[100px] md:text-[140px] text-white opacity-[0.03]"><i class="fa-solid fa-fire"></i></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-orange-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-slate-800 text-orange-400 rounded-2xl flex items-center justify-center text-xl md:text-2xl border border-slate-700 transition-all group-hover:scale-110 group-hover:bg-orange-500 group-hover:text-white group-hover:border-orange-400">
                            <i class="fa-solid fa-bell-concierge"></i>
                        </div>
                        <div class="relative z-10 text-left text-white mt-4 md:mt-6">
                            <h3 class="font-display font-bold text-xl md:text-2xl group-hover:text-orange-300 transition-colors">Cocina</h3>
                            <p class="text-xs md:text-sm text-slate-400 mt-1">Monitor KDS</p>
                        </div>
                        <div class="absolute bottom-4 right-4 w-8 h-8 rounded-full bg-slate-700 text-orange-400 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                            <i class="fa-solid fa-arrow-right text-sm"></i>
                        </div>
                    </button>
                    
                    <!-- CAJERO -->
                    <button onclick="APP.setRole('cajero')" class="group relative bg-white hover:-translate-y-1 md:hover:-translate-y-2 hover:shadow-card-hover transition-all duration-300 p-6 md:p-8 rounded-3xl border-2 border-transparent hover:border-emerald-400 flex flex-col items-start overflow-hidden shadow-card tap-effect">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="w-12 h-12 md:w-14 md:h-14 bg-gradient-to-br from-emerald-100 to-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center text-xl md:text-2xl transition-all group-hover:scale-110 group-hover:shadow-lg group-hover:shadow-emerald-500/20">
                            <i class="fa-solid fa-cash-register"></i>
                        </div>
                        <div class="relative z-10 text-left mt-4 md:mt-6">
                            <h3 class="font-display font-bold text-xl md:text-2xl text-slate-800 group-hover:text-emerald-600 transition-colors">Caja</h3>
                            <p class="text-xs md:text-sm text-slate-400 mt-1">Cobros y reportes</p>
                        </div>
                        <div class="absolute bottom-4 right-4 w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0">
                            <i class="fa-solid fa-arrow-right text-sm"></i>
                        </div>
                    </button>
                </div>
                
                <!-- Footer info -->
                <p class="text-center text-[10px] text-slate-300 mt-8 font-medium tracking-wider">MENUDERÍA DE LA PROGRESO • SISTEMA V7.0</p>
            </div>
        </div>

        <!-- VISTA 1: MESERO (MENU Y COMANDA) -->
        <div id="v-mesero" class="hidden absolute inset-0 z-30 flex-col md:flex-row bg-slate-50">
            <!-- Lado Izquierdo: Menú -->
            <div class="flex-1 flex flex-col relative h-full overflow-hidden">
                <div class="sticky-nav px-3 py-2.5 z-30">
                    <div class="relative max-w-xl mx-auto">
                        <i class="fa-solid fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                        <input type="text" id="m-search" onkeyup="UI.filterMenu(this.value)" placeholder="Buscar platillo..." class="w-full pl-10 pr-4 py-3 bg-slate-100/80 rounded-xl text-sm font-medium text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-orange-400 focus:bg-white transition-all border border-transparent focus:border-orange-200">
                    </div>
                </div>

                <div id="m-cats-wrapper" class="px-3 py-2 bg-white/90 backdrop-blur-lg z-20 border-b border-slate-100/50">
                    <div id="m-cat-nav" class="flex gap-2 overflow-x-auto hide-scroll py-1 snap-x"></div>
                </div>

                <div id="m-grid" class="flex-1 overflow-y-auto p-3 md:p-6 pb-28 md:pb-8 w-full max-w-7xl mx-auto scroll-smooth hide-scroll"></div>

                <!-- Boton flotante Mobile - MEJORADO -->
                <div class="md:hidden absolute bottom-4 left-3 right-3 z-40 animate-up">
                    <button onclick="UI.toggleCartMobile(true)" class="w-full bg-gradient-to-r from-slate-900 to-slate-800 text-white h-[60px] rounded-2xl shadow-floating flex items-center justify-between px-5 tap-effect border border-slate-700/50 shine-effect">
                        <div class="flex items-center gap-3">
                            <span id="m-badge-float" class="w-7 h-7 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 text-[11px] font-bold flex items-center justify-center shadow-lg shadow-orange-500/40">0</span>
                            <span class="font-semibold text-sm">Ver Pedido</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="m-total-float" class="font-display font-black text-xl">$0.00</span>
                            <i class="fa-solid fa-chevron-up text-slate-400 text-xs"></i>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Lado Derecho: Carrito/Comanda - MEJORADO -->
            <div id="m-cart-panel" class="absolute inset-0 md:static bg-white z-[60] flex flex-col transform translate-y-full md:translate-y-0 transition-transform duration-300 ease-out md:w-[420px] lg:w-[480px] shadow-2xl md:shadow-none md:border-l border-slate-200/50">
                <div class="flex-none px-4 py-4 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-white to-slate-50 z-10 safe-top">
                    <div>
                        <h2 class="font-display font-black text-lg text-slate-800 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                            Orden Actual
                        </h2>
                        <p class="text-[10px] font-semibold uppercase text-slate-400 tracking-wider">Detalle del Consumo</p>
                    </div>
                    <button onclick="UI.toggleCartMobile(false)" class="md:hidden w-9 h-9 rounded-xl bg-slate-100 text-slate-500 tap-effect flex items-center justify-center hover:bg-slate-200 transition-colors"><i class="fa-solid fa-chevron-down"></i></button>
                </div>

                <div class="px-4 py-3 bg-slate-50/80">
                    <div class="relative">
                        <i class="fa-solid fa-location-dot absolute left-3.5 top-1/2 -translate-y-1/2 text-orange-500"></i>
                        <select id="sel-mesa" class="w-full pl-10 pr-8 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-orange-400 appearance-none shadow-sm cursor-pointer hover:border-orange-300 transition-colors">
                            <option value="" disabled selected>Selecciona Ubicación...</option>
                            <option value="1">Mesa 1 (Sala)</option><option value="2">Mesa 2 (Sala)</option>
                            <option value="3">Mesa 3 (Sala)</option><option value="4">Mesa 4 (Sala)</option>
                            <option value="5">Mesa 5 (Jardín)</option><option value="6">Mesa 6 (Jardín)</option>
                            <option value="7">Mesa 7 (VIP)</option><option value="8">Mesa 8 (VIP)</option>
                            <option value="9">Mesa 9 (VIP)</option><option value="10">Mesa 10 (VIP)</option><option value="11">Mesa 11 (VIP)</option>
                            <option value="12">Mesa 12 (Afuera)</option><option value="13">Mesa 13 (Afuera)</option>
                            <option value="14">Mesa 14 (Afuera)</option><option value="15">Mesa 15 (Afuera)</option>
                            <option value="LLEVAR">📦 PARA LLEVAR</option>
                        </select>
                        <i class="fa-solid fa-angle-down absolute right-3.5 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none"></i>
                    </div>
                </div>

                <div id="m-cart-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50/50 hide-scroll"></div>

                <div class="p-4 bg-white border-t border-slate-100 safe-bottom">
                    <!-- Botón Platillo Especial - MEJORADO -->
                    <button onclick="LOGIC.addSpecialItem()" class="w-full mb-3 bg-gradient-to-r from-violet-500 to-purple-600 text-white py-2.5 rounded-xl shadow-md flex items-center justify-center gap-2 tap-effect hover:shadow-lg hover:shadow-purple-500/30 transition-all text-sm">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <span class="font-semibold">+ Platillo Especial</span>
                    </button>
                    
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total</span>
                        <span id="m-cart-total" class="font-display font-black text-3xl text-slate-900">$0.00</span>
                    </div>
                    <button onclick="LOGIC.sendOrder(this)" class="group w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white h-12 rounded-xl shadow-lg shadow-orange-500/30 flex items-center justify-center gap-2 transition-all tap-effect shine-effect">
                        <span class="font-bold">Enviar a Cocina</span>
                        <i class="fa-solid fa-paper-plane group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA 2: COCINA (MONITOR KDS - DISEÑO GRANDE Y LEGIBLE) -->
        <div id="v-cocina" class="hidden absolute inset-0 z-30 flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-3 md:p-4 overflow-hidden">
            <!-- Header KDS - Compacto -->
            <div class="flex justify-between items-center mb-4 bg-white/10 backdrop-blur-xl px-4 py-3 rounded-2xl border border-white/10 sticky top-0 z-20 flex-none">
                <div>
                    <h1 class="text-xl md:text-2xl font-display font-black text-white tracking-tight flex items-center gap-2">
                        <i class="fa-solid fa-fire text-orange-400 animate-pulse"></i> COCINA
                    </h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Monitor de Producción</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="UI.playSound()" class="text-white/60 hover:text-orange-400 text-xs font-bold uppercase bg-white/10 px-3 py-2 rounded-xl hover:bg-white/20 transition-all tap-effect hidden md:flex items-center gap-1">
                        <i class="fa-solid fa-bell"></i> Test
                    </button>
                    <div class="px-4 py-2 bg-orange-500/20 rounded-xl border border-orange-500/30 flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-orange-400 animate-pulse shadow-[0_0_10px_rgba(251,146,60,0.8)]"></span>
                        <span class="text-sm font-bold text-white">Pendientes: <b id="k-count" class="text-orange-400 text-xl ml-1">0</b></span>
                    </div>
                </div>
            </div>
            
            <!-- GRID KDS: Cards grandes con texto legible -->
            <div id="k-grid" class="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 pb-32 items-start content-start hide-scroll"></div>
        </div>

        <!-- VISTA 3: CAJERO (DISEÑO OPTIMIZADO MÓVIL) -->
        <div id="v-cajero" class="hidden absolute inset-0 z-30 flex-col bg-slate-50">
            <!-- Header Tabs - Compacto y moderno -->
            <div class="flex-none h-14 border-b border-slate-200/50 flex items-center justify-between px-3 md:px-6 bg-white/95 backdrop-blur-xl z-20 sticky top-0 shadow-sm">
                <div class="flex gap-1 md:gap-2 h-full">
                    <button onclick="UI.cajaTab('active')" id="btn-tab-act" class="h-full px-3 md:px-4 transition-all flex items-center gap-1.5 text-xs md:text-sm font-semibold rounded-none border-b-2 border-orange-500 text-orange-600 bg-orange-50/50">
                        <i class="fa-solid fa-receipt"></i> <span>Activas</span>
                    </button>
                    <button onclick="UI.cajaTab('report')" id="btn-tab-rep" class="h-full px-3 md:px-4 transition-all flex items-center gap-1.5 text-xs md:text-sm font-semibold rounded-none border-b-2 border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50">
                        <i class="fa-solid fa-chart-pie"></i> <span>Finanzas</span>
                    </button>
                </div>
                <div class="flex gap-1.5">
                    <button onclick="LOGIC.addExpense()" class="text-[10px] md:text-xs bg-red-50 text-red-600 font-semibold px-2.5 py-2 rounded-lg hover:bg-red-100 border border-red-200/50 transition-all tap-effect flex items-center gap-1">
                        <i class="fa-solid fa-minus-circle"></i> <span class="hidden md:inline">Gasto</span>
                    </button>
                    <button onclick="LOGIC.manualSale()" class="text-[10px] md:text-xs bg-slate-100 text-slate-600 font-semibold px-2.5 py-2 rounded-lg hover:bg-slate-200 border border-slate-200/50 transition-all tap-effect flex items-center gap-1">
                        <i class="fa-solid fa-plus-circle"></i> <span class="hidden md:inline">Venta</span>
                    </button>
                </div>
            </div>

            <div class="flex-1 relative bg-gradient-to-b from-slate-50 to-slate-100 overflow-hidden">
                <!-- Panel 1: Mesas Activas -->
                <div id="p-active" class="absolute inset-0 overflow-y-auto p-3 md:p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4 content-start pb-32 hide-scroll"></div>

                <!-- Panel 2: Reporte Financiero Completo (Optimizado Mobile) -->
                <div id="p-report" class="hidden absolute inset-0 overflow-y-auto p-3 md:p-6 bg-gradient-to-b from-slate-50 to-slate-100 pb-32 hide-scroll">
                    <div class="max-w-7xl mx-auto space-y-4 md:space-y-6">
                        
                        <!-- SECCION FONDO CAJA (Compacto Mobile) -->
                        <div class="bg-white rounded-2xl p-3 md:p-5 shadow-sm border border-slate-200 flex items-center justify-between gap-3 animate-in">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-br from-indigo-400 to-violet-500 text-white rounded-xl flex items-center justify-center text-lg shrink-0 shadow-lg shadow-indigo-500/20"><i class="fa-solid fa-vault"></i></div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-sm md:text-base">Fondo Caja</h3>
                                    <p class="text-[10px] md:text-xs text-slate-400">Inversión inicial</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 bg-slate-50 p-2 rounded-xl">
                                <span class="font-display font-black text-lg md:text-xl text-slate-400">$</span>
                                <input type="number" id="inp-fondo" onchange="STATE.cashFund = parseFloat(this.value)||0; UI.toast('Fondo Actualizado')" placeholder="0.00" class="w-20 md:w-28 bg-transparent border-b-2 border-indigo-200 focus:border-indigo-500 outline-none text-lg md:text-xl font-black text-slate-800 text-center py-1 transition-colors" />
                            </div>
                        </div>

                        <!-- KPIs CARDS (Optimizados Mobile) -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                            <div class="col-span-2 md:col-span-1 relative overflow-hidden rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 p-4 md:p-6 text-white shadow-xl">
                                <i class="fa-solid fa-coins absolute -right-4 -bottom-4 text-[80px] md:text-[100px] opacity-10 rotate-12 text-white"></i>
                                <p class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-slate-400 mb-1">Ventas Hoy</p>
                                <p id="rp-tot" class="font-display font-black text-3xl md:text-4xl">$0.00</p>
                            </div>
                            <div class="rounded-2xl bg-white border border-slate-200 p-4 md:p-6 relative shadow-sm">
                                <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-green-50 text-green-600 flex items-center justify-center absolute top-4 md:top-6 right-4 md:right-6 text-sm md:text-base"><i class="fa-solid fa-money-bill-wave"></i></div>
                                <p class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-slate-400 mb-1">Efectivo</p>
                                <p id="rp-cash" class="font-display font-black text-2xl md:text-3xl text-slate-800">$0.00</p>
                            </div>
                            <div class="rounded-2xl bg-white border border-slate-200 p-4 md:p-6 relative shadow-sm">
                                <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center absolute top-4 md:top-6 right-4 md:right-6 text-sm md:text-base"><i class="fa-regular fa-credit-card"></i></div>
                                <p class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-slate-400 mb-1">Tarjeta</p>
                                <p id="rp-card" class="font-display font-black text-2xl md:text-3xl text-slate-800">$0.00</p>
                            </div>
                            <div class="rounded-2xl bg-red-50 border border-red-200 p-4 md:p-6 relative shadow-sm">
                                <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-red-100 text-red-600 flex items-center justify-center absolute top-4 md:top-6 right-4 md:right-6 text-sm md:text-base"><i class="fa-solid fa-arrow-trend-down"></i></div>
                                <p class="text-[10px] md:text-xs font-bold uppercase tracking-widest text-red-400 mb-1">Gastos</p>
                                <p id="rp-gastos" class="font-display font-black text-2xl md:text-3xl text-red-600">$0.00</p>
                            </div>
                        </div>

                        <!-- Grids de Datos (Optimizado Mobile) -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                             <!-- Productos List -->
                             <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm flex flex-col h-[350px] md:h-[450px]">
                                <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-800 flex gap-2 items-center text-sm"><i class="fa-solid fa-chart-simple text-orange-500"></i> Mix Ventas</h3>
                                </div>
                                <div class="flex-1 overflow-auto hide-scroll">
                                    <table class="w-full text-left text-sm">
                                        <thead class="bg-white text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-wider sticky top-0 z-10 border-b border-slate-100 shadow-sm">
                                            <tr><th class="px-3 md:px-6 py-2 md:py-3">Item</th><th class="px-3 md:px-6 py-2 md:py-3 text-center">#</th><th class="px-3 md:px-6 py-2 md:py-3 text-right">$</th></tr>
                                        </thead>
                                        <tbody id="rp-rows" class="divide-y divide-slate-100 text-slate-600 bg-white"></tbody>
                                    </table>
                                </div>
                             </div>

                             <!-- Transacciones y Descarga PDF -->
                             <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm flex flex-col h-[350px] md:h-[450px]">
                                <div class="px-3 md:px-4 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center gap-2">
                                    <h3 class="font-bold text-slate-800 flex gap-2 items-center text-sm"><i class="fa-solid fa-list-ul text-blue-500"></i> Historial</h3>
                                    <button onclick="UI.generatePDF()" class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-400 hover:to-orange-500 text-white px-3 py-1.5 rounded-lg text-[10px] md:text-xs font-bold transition-all shadow-lg shadow-orange-500/20 flex items-center justify-center gap-1.5 tap-effect">
                                        <i class="fa-solid fa-file-pdf"></i> <span class="hidden md:inline">Reporte</span> PDF
                                    </button>
                                </div>
                                <div class="flex-1 overflow-auto hide-scroll">
                                     <table class="w-full text-left text-sm">
                                        <thead class="bg-white text-[9px] md:text-[10px] font-black text-slate-400 uppercase tracking-wider sticky top-0 z-10 border-b border-slate-100 shadow-sm">
                                            <tr><th class="px-3 py-2 md:py-3">Detalle</th><th class="px-3 py-2 md:py-3 text-right">Monto</th><th class="px-3 py-2 md:py-3 text-center">Ctrl</th></tr>
                                        </thead>
                                        <tbody id="rp-trans" class="divide-y divide-slate-100 text-slate-600 bg-white"></tbody>
                                    </table>
                                </div>
                             </div>
                        </div>

                        <div class="pt-6 pb-8 text-center border-t border-slate-200">
                             <button onclick="LOGIC.resetAll()" class="text-[10px] text-red-300 hover:text-red-500 font-black uppercase tracking-[0.2em] transition hover:bg-red-50 px-4 py-2 rounded-lg">Reset Sistema (Cerrar Día)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- E. MODAL DE PAGO -->
    <div id="modal-pay" class="fixed inset-0 z-[100] hidden items-center justify-center p-3 md:p-4">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-md transition-opacity duration-300" onclick="UI.modalPay(false)"></div>
        <div class="bg-white w-full max-w-[380px] md:max-w-[450px] rounded-3xl p-4 md:p-6 relative shadow-2xl animate-up max-h-[90vh] overflow-y-auto hide-scroll">
            <button onclick="UI.modalPay(false)" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center transition-colors"><i class="fa-solid fa-xmark"></i></button>
            <div class="text-center mt-1">
                <div class="w-12 h-12 md:w-14 md:h-14 mx-auto bg-gradient-to-br from-green-400 to-emerald-500 text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-green-500/30 mb-3">
                    <i class="fa-solid fa-cash-register"></i>
                </div>
                <h3 class="text-[9px] md:text-[10px] font-black uppercase text-slate-400 tracking-[0.2em]">Cobrar Cuenta</h3>
                <h2 id="pay-mesa-label" class="font-display font-black text-xl md:text-2xl text-slate-900 mt-1 mb-3">Mesa ?</h2>
                
                <!-- Selección de Items -->
                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 mb-3 text-left">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-list-check"></i> Selecciona artículos a cobrar</span>
                        <button onclick="UI.toggleAllItems()" class="text-[9px] bg-indigo-100 text-indigo-600 px-2 py-1 rounded-lg font-bold hover:bg-indigo-200 transition tap-effect">Todos</button>
                    </div>
                    <div id="pay-items-list" class="space-y-1.5 max-h-[30vh] overflow-y-auto hide-scroll">
                        <!-- Items se llenan dinámicamente -->
                    </div>
                </div>
                
                <!-- Total Seleccionado -->
                <div class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 rounded-2xl p-3 md:p-4 mb-3">
                    <span class="text-[9px] md:text-[10px] font-bold text-slate-400 uppercase">Total a Cobrar</span>
                    <span id="pay-amount-label" class="block font-display font-black text-3xl md:text-4xl text-slate-800 tracking-tight">$0.00</span>
                    <span id="pay-items-count" class="text-[10px] text-slate-400 font-medium">0 artículos seleccionados</span>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="LOGIC.processPayment('Efectivo', this)" class="pay-btn group relative bg-white border-2 border-slate-200 hover:border-green-400 hover:bg-green-50 p-3 md:p-4 rounded-2xl transition-all tap-effect shadow-sm">
                        <div class="content flex flex-col items-center gap-1.5 text-slate-600 group-hover:text-green-700">
                            <i class="fa-solid fa-money-bill-wave text-lg md:text-xl opacity-50 group-hover:opacity-100"></i><span class="font-bold text-xs md:text-sm">Efectivo</span>
                        </div>
                    </button>
                    <button onclick="LOGIC.processPayment('Tarjeta', this)" class="pay-btn group relative bg-white border-2 border-slate-200 hover:border-blue-400 hover:bg-blue-50 p-3 md:p-4 rounded-2xl transition-all tap-effect shadow-sm">
                        <div class="content flex flex-col items-center gap-1.5 text-slate-600 group-hover:text-blue-700">
                            <i class="fa-regular fa-credit-card text-lg md:text-xl opacity-50 group-hover:opacity-100"></i><span class="font-bold text-xs md:text-sm">Tarjeta</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- F. MODAL EDITAR ITEMS DE ORDEN -->
    <div id="modal-edit-items" class="fixed inset-0 z-[100] hidden items-center justify-center p-3 md:p-4">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-md transition-opacity duration-300" onclick="UI.closeEditModal()"></div>
        <div class="bg-white w-full max-w-[380px] md:max-w-[420px] rounded-3xl p-4 md:p-6 relative shadow-2xl animate-up max-h-[85vh] overflow-hidden flex flex-col">
            <button onclick="UI.closeEditModal()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center transition-colors z-10"><i class="fa-solid fa-xmark"></i></button>
            <div class="text-center mb-4">
                <div class="w-12 h-12 md:w-14 md:h-14 mx-auto bg-gradient-to-br from-amber-400 to-orange-500 text-white rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-orange-500/30 mb-3">
                    <i class="fa-solid fa-pen-to-square"></i>
                </div>
                <h3 class="text-[9px] md:text-[10px] font-black uppercase text-slate-400 tracking-[0.2em]">Editar Orden <span id="edit-order-id" class="text-slate-500"></span></h3>
                <h2 id="edit-mesa-label" class="font-display font-black text-xl md:text-2xl text-slate-900 mt-1">Mesa ?</h2>
            </div>
            
            <!-- Lista de items editables -->
            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 mb-3 flex-1 overflow-hidden flex flex-col">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1"><i class="fa-solid fa-utensils"></i> Platillos en la orden</span>
                </div>
                <div id="edit-items-list" class="space-y-1.5 flex-1 overflow-y-auto hide-scroll">
                    <!-- Items se llenan dinámicamente -->
                </div>
            </div>
            
            <!-- Total -->
            <div class="bg-gradient-to-br from-slate-100 to-slate-200 border border-slate-300 rounded-2xl p-3 text-center">
                <span class="text-[9px] font-bold text-slate-400 uppercase">Total Actual</span>
                <span id="edit-total-label" class="block font-display font-black text-2xl text-slate-800">$0.00</span>
            </div>
            
            <p class="text-[9px] text-slate-400 text-center mt-3"><i class="fa-solid fa-info-circle mr-1"></i>Toca el ícono de basura para eliminar un platillo</p>
        </div>
    </div>

    <!-- LOGICA DEL SISTEMA -->
    <script type="module">
        // 1. IMPORTACIÓN MODULAR DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, writeBatch, serverTimestamp, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // 2. CONFIGURACIÓN E INICIALIZACIÓN
        const app = initializeApp({
            apiKey: "AIzaSyD3skMKdCxzCkWQZ--AxMgPEuW4imE3zlA",
            authDomain: "lacabana-pos.firebaseapp.com",
            projectId: "lacabana-pos",
            storageBucket: "lacabana-pos.firebasestorage.app",
            messagingSenderId: "638951958072",
            appId: "1:638951958072:web:293bb08e1a1cdd74d0e8cd"
        });
        const db = getFirestore(app);
        const auth = getAuth(app);
        const ORDERS_COL = collection(db, 'artifacts', 'lacabana-progreso', 'public', 'data', 'ordenes');

        // 3. CATALOGO DIGITAL DEL MENU
        const MENU_DB = [
            { id: 'caldos', name: 'Caldos y Menudo', icon: 'fa-bowl-rice', items: [
                {n: 'Menudo Rojo Chico', p: 140}, {n: 'Menudo Rojo Mediano', p: 160}, {n: 'Menudo Rojo Grande', p: 200},
                {n: 'Menudo Blanco Chico', p: 140}, {n: 'Menudo Blanco Mediano', p: 160}, {n: 'Menudo Blanco Grande', p: 200},
                {n: 'Consomé Vaso', p: 20},
                {n: 'Pata Extra', p: 40} // AGREGADO
            ]},
            { id: 'barba', name: 'Barbacoa', icon: 'fa-fire-burner', items: [
                {n: 'Taco Suave', p: 30}, {n: 'Taco Dorado', p: 30},
                {n: 'Orden Media (Carne)', p: 160}, {n: 'Orden Media (Caldo)', p: 180},
                {n: 'Orden Grande (Carne)', p: 200}, {n: 'Orden Grande (Caldo)', p: 210}
            ]},
            { id: 'quesa', name: 'Quesabirrias', icon: 'fa-cheese', items: [
                {n: 'Quesabirria Sola', p: 80}, {n: 'Media Quesa (1 pza + Guarn)', p: 130}, {n: 'Orden Quesa (2 pza + Guarn)', p: 180}
            ]},
            // PAQUETES (COMBOS) ELIMINADO
            { id: 'especial', name: 'Especiales', icon: 'fa-star', items: [
                {n: 'Platillo del Día', p: 180}, // AGREGADO
                {n: 'Orden de Pan', p: 20}, // AGREGADO
                {n: 'Postre', p: 50} // AGREGADO
            ]},
            { id: 'bebi', name: 'Bebidas', icon: 'fa-glass-water', items: [
                {n: 'Refresco Lata', p: 30}, {n: 'Café de Olla', p: 30}, {n: 'Agua Fresca 1L', p: 45}, {n: 'Botella Agua', p: 25}
            ]}
        ];

        // *** SONIDO (Campana agradable) ***
        const AUDIO_BELL = new Audio('https://cdn.freesound.org/previews/411/411089_5121236-lq.mp3'); 
        AUDIO_BELL.volume = 1.0;
        AUDIO_BELL.preload = 'auto';
        // Precargar el sonido
        AUDIO_BELL.load();

        // ESTADO GLOBAL DE LA APP
        let STATE = { 
            cart: [], 
            role: null, 
            orders: [], 
            payData: { id: null, amount: 0, table: '' }, 
            reportSummary: null,
            cashFund: 0, 
            lastPendingCount: -1 // Detector de nuevas ordenes (-1 = carga inicial)
        };

        window.UI = {
            format: (num) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(num),
            
            // REPRODUCTOR DE SONIDO ÚNICO (con respaldo)
            playSound: () => {
                // Intentar con Web Audio API primero para mejor compatibilidad
                try {
                    // Reiniciar para poder reproducir múltiples veces rápido
                    AUDIO_BELL.currentTime = 0;
                    AUDIO_BELL.volume = 1.0;
                    
                    var playPromise = AUDIO_BELL.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            console.log("🔔 Campana reproducida");
                        }).catch(error => {
                            console.log("Audio requiere interacción:", error);
                            // Respaldo: crear sonido con Web Audio API
                            UI.playBeepFallback();
                        });
                    }
                } catch(e) {
                    console.log("Error audio:", e);
                    UI.playBeepFallback();
                }
            },
            
            // Sonido de respaldo usando Web Audio API (funciona sin archivo externo)
            playBeepFallback: () => {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    // Tono agradable tipo campana
                    oscillator.frequency.value = 830; // Nota alta
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.5);
                    
                    // Segunda nota para efecto de campana
                    setTimeout(() => {
                        const osc2 = audioCtx.createOscillator();
                        const gain2 = audioCtx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        osc2.frequency.value = 1046; // Nota más alta
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.2, audioCtx.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc2.start(audioCtx.currentTime);
                        osc2.stop(audioCtx.currentTime + 0.3);
                    }, 100);
                } catch(e) {
                    console.log("Web Audio no disponible");
                }
            },

            // --- MOTOR LOGICO DE TIEMPO REAL VISUAL (KDS) ---
            getTimerState: (ts) => {
                if(!ts) return { str: '00:00', state: 'fresh' };
                let d = ts.seconds ? new Date(ts.seconds * 1000) : (ts instanceof Date ? ts : new Date());
                const now = new Date();
                const diffSecs = Math.floor((now - d) / 1000);
                
                const mm = Math.floor(diffSecs / 60).toString().padStart(2, '0');
                const ss = (diffSecs % 60).toString().padStart(2, '0');
                
                let state = 'fresh'; 
                if(diffSecs > 600) state = 'warning'; 
                if(diffSecs > 1200) state = 'critical'; 

                return { str: `${mm}:${ss}`, state };
            },

            // ACTUALIZACION EFICIENTE DEL DOM
            updateKitchenTimers: () => {
                if(STATE.role !== 'cocina') return;

                STATE.orders.forEach(o => {
                    if(o.status === 'en_cocina'){
                        const card = document.getElementById(`k-card-${o.id}`);
                        const badge = document.getElementById(`k-badge-${o.id}`);
                        
                        if(card && badge) {
                            const { str, state } = UI.getTimerState(o.ts);
                            badge.innerText = str;
                            if (!card.classList.contains(`state-${state}`)) {
                                card.classList.remove('state-fresh', 'state-warning', 'state-critical');
                                card.classList.add(`state-${state}`);
                            }
                        }
                    }
                });
            },

            // RENDERIZADORES DE VISTAS
            initMesero: () => {
                document.getElementById('m-cat-nav').innerHTML = MENU_DB.map(c => 
                    `<button onclick="document.getElementById('cat-${c.id}').scrollIntoView({behavior:'smooth',block:'start'})" class="whitespace-nowrap px-4 py-2.5 bg-white border border-slate-200 text-xs font-bold text-slate-500 rounded-xl hover:bg-brand-accent hover:text-white transition shadow-sm flex items-center gap-2 snap-start active:scale-95 select-none">
                        <i class="fa-solid ${c.icon}"></i> ${c.name}
                     </button>`
                ).join('');
                document.getElementById('m-grid').innerHTML = MENU_DB.map(c => `
                    <div id="cat-${c.id}" class="mb-10 scroll-mt-40">
                        <div class="flex items-center gap-3 mb-5 px-1"><span class="w-1.5 h-6 rounded-full bg-brand-accent"></span><h3 class="text-xl font-display font-black text-slate-800">${c.name}</h3></div>
                        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                            ${c.items.map(i => `
                                <div onclick="LOGIC.cartAdd('${i.n}',${i.p})" class="bg-white p-5 rounded-[20px] shadow-sm border border-slate-100 hover:border-brand-accent cursor-pointer transition-all duration-200 tap-effect group h-[140px] flex flex-col justify-between relative overflow-hidden select-none">
                                    <div class="absolute -right-4 -bottom-4 text-7xl text-slate-100 group-hover:text-orange-50 transition-colors -rotate-12"><i class="fa-solid ${c.icon}"></i></div>
                                    <div class="relative z-10"><p class="font-bold text-slate-700 text-sm leading-tight">${i.n}</p></div>
                                    <div class="relative z-10 flex justify-between items-end">
                                        <p class="font-display font-black text-lg text-slate-900">${UI.format(i.p)}</p>
                                        <div class="w-10 h-10 rounded-full bg-slate-50 text-brand-accent flex items-center justify-center shadow-sm group-hover:bg-brand-accent group-hover:text-white transition-colors"><i class="fa-solid fa-plus text-sm"></i></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            },

            filterMenu: (q) => {
                const term = q.toLowerCase();
                document.querySelectorAll('#m-grid .group').forEach(el => {
                    el.style.display = el.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
                });
            },

            renderCart: () => {
                const list = document.getElementById('m-cart-list');
                let total = 0, html = '';
                if(STATE.cart.length===0) html = `<div class="h-64 flex flex-col items-center justify-center text-slate-300 gap-2 select-none"><i class="fa-solid fa-cart-shopping text-3xl opacity-30"></i><span class="text-xs font-bold uppercase tracking-widest opacity-50">Comanda Vacía</span></div>`;
                else STATE.cart.forEach((item,idx)=>{
                    total += (item.p * item.qty);
                    html += `
                    <div class="flex items-start gap-3 bg-white p-3 rounded-2xl border border-slate-100 shadow-sm animate-in relative group hover:border-orange-200">
                        <div class="flex-1">
                            <p class="text-xs font-bold text-slate-700 leading-snug">${item.n}</p>
                            <p class="text-[10px] text-slate-400 font-medium mt-0.5">${UI.format(item.p)} x ${item.qty}</p>
                            ${item.note ? `<div class="mt-1 bg-yellow-50 text-yellow-800 text-[9px] px-1.5 py-0.5 rounded border border-yellow-100 font-bold inline-block"><i class="fa-solid fa-pen text-[8px] mr-1"></i>${item.note}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-end gap-2">
                             <div class="flex items-center bg-slate-50 rounded-lg p-1 border border-slate-100">
                                <button onclick="LOGIC.cartUpd(${idx},-1)" class="w-8 h-8 flex items-center justify-center bg-white text-slate-500 rounded hover:text-red-500 shadow-sm transition font-bold tap-effect text-lg">-</button>
                                <span class="w-7 text-center text-xs font-black text-slate-700 select-none">${item.qty}</span>
                                <button onclick="LOGIC.cartUpd(${idx},1)" class="w-8 h-8 flex items-center justify-center bg-white text-slate-500 rounded hover:text-green-600 shadow-sm transition font-bold tap-effect text-lg">+</button>
                             </div>
                             <button onclick="LOGIC.cartNote(${idx})" class="text-[10px] text-slate-400 font-bold underline hover:text-brand-accent p-1">Nota</button>
                        </div>
                    </div>`;
                });
                list.innerHTML = html;
                const fmt = UI.format(total);
                document.getElementById('m-cart-total').innerText = fmt;
                document.getElementById('m-total-float').innerText = fmt;
                document.getElementById('m-badge-float').innerText = STATE.cart.length;
            },

            toggleCartMobile: (show) => {
                const el = document.getElementById('m-cart-panel');
                if(show) { el.classList.remove('translate-y-full','md:translate-y-0'); void el.offsetWidth; }
                else el.classList.add('translate-y-full');
            },

            toast: (msg, type='info') => {
                const div = document.createElement('div');
                div.className = `${type==='error'?'bg-red-500':(type==='success'?'bg-green-600':'bg-slate-800')} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300`;
                div.innerHTML = `<div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-xs"><i class="fa-solid ${type==='error'?'fa-times':'fa-check'}"></i></div><span class="font-bold text-sm">${msg}</span>`;
                document.getElementById('toast-container').appendChild(div);
                requestAnimationFrame(()=>div.classList.remove('translate-y-10','opacity-0'));
                setTimeout(()=>{div.classList.add('opacity-0','translate-x-full');setTimeout(()=>div.remove(),300)},3000);
            },

            renderOrders: () => {
                // RENDER VISTA COCINA (KDS MEJORADO CON SCROLL INFINITO Y AUDIO)
                // Cocina ve: tickets de cocina adicionales (isKitchenTicket=true) O ordenes principales nuevas (sin parentOrder y sin isKitchenTicket)
                if(STATE.role==='cocina'){
                    const pend = STATE.orders.filter(o=>o.status==='en_cocina' && (o.isKitchenTicket === true || (!o.isKitchenTicket && !o.parentOrder))).sort((a,b)=>{
                        const tsA = a.ts?.seconds || 0;
                        const tsB = b.ts?.seconds || 0;
                        return tsA - tsB;
                    });
                    document.getElementById('k-count').innerText = pend.length;
                    
                    // --- LOGICA DE AUDIO ---
                    // Si la cantidad de pendientes es mayor que la anterior, reproducir sonido
                    // lastPendingCount === -1 significa que es la carga inicial (ignorar para no sonar al entrar)
                    if(pend.length > STATE.lastPendingCount && STATE.lastPendingCount >= 0) { 
                        UI.playSound(); // Notificación sonora
                        UI.toast('¡Nueva Comanda Recibida!', 'success');
                    }
                    STATE.lastPendingCount = pend.length;

                    document.getElementById('k-grid').innerHTML = pend.map(o => {
                        const { str, state } = UI.getTimerState(o.ts); 
                        // KDS CARD OPTIMIZADO CON LETRAS GRANDES PARA COCINA
                        return `
                        <div id="k-card-${o.id}" class="kds-card-base state-${state} bg-slate-800 rounded-2xl shadow-2xl flex flex-col animate-up relative group break-inside-avoid h-full w-full max-h-[600px] border border-white/10">
                            <div class="kds-header p-4 md:p-5 flex justify-between items-center transition-colors duration-500 flex-none rounded-t-2xl">
                                <div class="flex flex-col">
                                    <span class="font-display font-black text-4xl md:text-5xl leading-none text-white drop-shadow-lg">MESA ${o.mesa}</span>
                                    <span class="text-sm md:text-base uppercase tracking-widest opacity-90 mt-1 font-bold ${o.isKitchenTicket ? 'text-yellow-300' : 'text-white/70'}">${o.isKitchenTicket ? '🆕 ADICIONAL' : 'Ticket #'+o.id.slice(0,4)}</span>
                                </div>
                                <div id="k-badge-${o.id}" class="kds-timer-badge px-4 py-2 rounded-xl text-2xl md:text-3xl font-mono tracking-wider transition-colors duration-500 font-black shadow-lg">
                                    ${str}
                                </div>
                            </div>
                            <!-- Cuerpo con items GRANDES -->
                            <div class="flex-1 overflow-y-auto inner-scroll bg-slate-900/50 relative p-4 max-h-[400px] hide-scroll">
                                <ul class="space-y-3">
                                ${o.items.map(i=>`
                                    <li class="flex items-start gap-3 bg-white/5 p-3 rounded-xl border border-white/10">
                                        <span class="flex-none font-black bg-orange-500 text-white px-4 py-2 rounded-xl text-3xl md:text-4xl shadow-lg min-w-[60px] text-center">${i.qty}</span>
                                        <div class="flex-1 py-1">
                                            <div class="text-2xl md:text-3xl font-bold text-white leading-tight tracking-tight">${i.n}</div>
                                            ${i.note ? `<div class="bg-yellow-500/20 text-yellow-300 text-lg md:text-xl px-3 py-2 mt-2 rounded-lg border-l-4 border-yellow-400 font-bold inline-block w-full"><i class="fa-solid fa-exclamation-triangle mr-2"></i>${i.note.toUpperCase()}</div>`:''}
                                        </div>
                                    </li>`).join('')}
                                </ul>
                            </div>
                            <div class="p-3 md:p-4 bg-slate-800/80 border-t border-white/10 mt-auto rounded-b-2xl z-10 flex-none">
                                <button onclick="LOGIC.statusUpd('${o.id}','en_mesa')" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-black py-4 md:py-5 rounded-xl transition-all shadow-lg shadow-green-500/30 uppercase text-lg md:text-xl tracking-wider tap-effect flex items-center justify-center gap-3">
                                    <i class="fa-solid fa-check-circle text-2xl"></i> ¡LISTO!
                                </button>
                            </div>
                        </div>`;
                    }).join('') || `<div class="col-span-full h-40 flex items-center justify-center text-white/30 font-bold text-xl border-2 border-dashed border-white/20 rounded-2xl bg-white/5"><i class="fa-solid fa-check-double mr-3 text-2xl"></i>Sin comandas pendientes</div>`;
                }

                // RENDER VISTA CAJERO (CON SCROLL INTERNO Y LISTA COMPLETA)
                // Caja NO ve los tickets de cocina (isKitchenTicket), ni los gastos (isExpense), solo las ordenes principales
                if(STATE.role==='cajero'){
                    const active = STATE.orders.filter(o=>o.status!=='pagado' && o.status!=='gasto' && !o.isKitchenTicket && !o.isExpense).sort((a,b)=>{
                        const tsA = a.ts?.seconds || 0;
                        const tsB = b.ts?.seconds || 0;
                        return tsA - tsB;
                    });
                    const paid = STATE.orders.filter(o=>(o.status==='pagado' || o.isExpense) && !o.isKitchenTicket).sort((a,b)=>{
                        const tsA = a.ts?.seconds || 0;
                        const tsB = b.ts?.seconds || 0;
                        return tsB - tsA;
                    });

                    // AQUI SE HA EXTENDIDO EL CODIGO PARA PERMITIR SCROLL Y VER TODOS LOS ITEMS
                    // Se elimina items.slice(0,4) y se coloca el map completo dentro de un div con scroll
                    document.getElementById('p-active').innerHTML = active.map(o=>`
                        <div class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all group flex flex-col border border-slate-200/50 overflow-hidden animate-in w-full h-fit">
                            <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-3 md:p-4 border-b border-slate-100 flex justify-between items-start flex-none">
                                <div>
                                    <div class="flex gap-2 items-center mb-1 flex-wrap">
                                        <span class="text-[9px] md:text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${o.status==='en_cocina'?'text-orange-600 bg-orange-100 border border-orange-200':'text-green-600 bg-green-100 border border-green-200'}">${o.status==='en_cocina'?'🔥 En Cocina':'✓ Entregado'}</span>
                                        <span class="text-[9px] font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">#${o.id.slice(0,4)}</span>
                                    </div>
                                    <h3 class="font-display font-black text-2xl md:text-3xl text-slate-800 mt-1">${isNaN(o.mesa)?'🛒 LLEVAR':`Mesa ${o.mesa}`}</h3>
                                </div>
                            </div>
                            
                            <!-- SECCION SCROLLABLE MEJORADA PARA MOVILES -->
                            <div class="flex-1 p-3 md:p-4 bg-white overflow-y-auto max-h-[25vh] md:max-h-[30vh] min-h-[80px] hide-scroll border-b border-slate-100">
                                <ul class="space-y-1.5 md:space-y-2 text-xs text-slate-500 font-medium">
                                    ${o.items.map(i => `
                                    <li class="flex justify-between items-start gap-2 py-1">
                                        <div class="flex gap-2 items-start flex-1 min-w-0">
                                            <span class="font-bold text-white bg-slate-700 px-1.5 py-0.5 rounded text-[10px] md:text-xs min-w-[22px] text-center flex-none">${i.qty}</span>
                                            <span class="leading-tight text-slate-600 text-xs md:text-sm truncate">${i.n}</span>
                                        </div>
                                        <span class="font-mono text-slate-800 font-bold text-xs whitespace-nowrap">${UI.format(i.qty*i.p)}</span>
                                    </li>`).join('')}
                                </ul>
                                <div class="mt-3 pt-2 border-t border-dashed border-slate-200 text-center text-[9px] md:text-[10px] text-slate-400">
                                    <i class="fa-solid fa-utensils mr-1"></i> ${o.items.reduce((acc, el) => acc + el.qty, 0)} artículos
                                </div>
                            </div>

                            <div class="p-3 md:p-4 bg-gradient-to-r from-slate-50 to-slate-100 flex justify-between items-center gap-2 flex-none">
                                <div class="flex flex-col">
                                    <span class="text-[9px] font-bold uppercase text-slate-400">Por cobrar</span>
                                    <span class="font-display font-black text-xl md:text-2xl text-slate-900 leading-none">${UI.format(o.total)}</span>
                                </div>
                                <div class="flex gap-1.5 flex-1 justify-end">
                                    <button onclick="UI.modalEditItems('${o.id}')" class="h-10 md:h-12 w-10 md:w-12 rounded-xl bg-white border-2 border-slate-200 text-slate-500 flex items-center justify-center hover:border-red-300 hover:text-red-500 hover:bg-red-50 transition-all tap-effect" title="Editar platillos">
                                        <i class="fa-solid fa-pen-to-square text-sm"></i>
                                    </button>
                                    <button onclick="UI.modalPay(true,'${o.id}','${o.mesa}',${o.total})" class="h-10 md:h-12 px-4 md:px-5 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white flex items-center justify-center hover:from-green-400 hover:to-emerald-500 transition-all shadow-lg shadow-green-500/30 tap-effect gap-2">
                                        <span class="font-bold text-xs md:text-sm uppercase">Cobrar</span>
                                        <i class="fa-solid fa-dollar-sign text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`).join('') || `<div class="col-span-full flex flex-col items-center justify-center text-slate-300 mt-10 h-48 md:h-64 border-2 border-dashed border-slate-200 rounded-3xl bg-white/50">
                            <i class="fa-solid fa-cash-register text-3xl md:text-4xl mb-2 opacity-50"></i>
                            <span class="text-xs md:text-sm font-bold uppercase tracking-widest">Sin cuentas activas</span>
                        </div>`;
                    
                    let t=0, c=0, cc=0, gastos=0, itMap={};
                    // Filtrar gastos de las ventas
                    const expenses = STATE.orders.filter(o => o.isExpense === true);
                    const sales = paid.filter(o => !o.isExpense);
                    
                    // Calcular gastos
                    expenses.forEach(e => { gastos += e.total; });
                    
                    // Calcular ventas
                    sales.forEach(o=>{ t+=o.total; if(o.method==='Efectivo')c+=o.total; else cc+=o.total; o.items.forEach(i=>{ if(!itMap[i.n])itMap[i.n]={q:0,s:0}; itMap[i.n].q+=i.qty; itMap[i.n].s+=(i.qty*i.p); }); });
                    STATE.reportSummary = {total:t, cash:c, card:cc, gastos:gastos, items:itMap, history: sales, expenses: expenses};

                    document.getElementById('rp-tot').innerText=UI.format(t);
                    document.getElementById('rp-cash').innerText=UI.format(c);
                    document.getElementById('rp-card').innerText=UI.format(cc);
                    document.getElementById('rp-gastos').innerText=UI.format(gastos);
                    document.getElementById('rp-rows').innerHTML = Object.entries(itMap).sort((a,b)=>b[1].s-a[1].s).map(([n,d])=>`<tr><td class="px-6 py-2 text-xs font-bold text-slate-700">${n}</td><td class="px-6 py-2 text-center text-xs bg-slate-50 text-slate-500 font-mono">${d.q}</td><td class="px-6 py-2 text-right text-xs font-bold text-slate-800">${UI.format(d.s)}</td></tr>`).join('');
                    
                    // Combinar ventas y gastos, ordenar por timestamp
                    const allTransactions = [...sales, ...expenses].sort((a,b) => {
                        const tsA = a.ts?.seconds || 0;
                        const tsB = b.ts?.seconds || 0;
                        return tsB - tsA;
                    });
                    
                    document.getElementById('rp-trans').innerHTML = allTransactions.map(o=>{
                        const isExpense = o.isExpense === true;
                        return `
                        <tr class="hover:bg-slate-50 transition ${isExpense ? 'bg-red-50/50' : ''}">
                            <td class="px-4 py-3 text-xs text-slate-600">
                                <div class="font-bold ${isExpense ? 'text-red-600' : 'text-slate-800'}">
                                    ${isExpense ? '⚠️ GASTO: ' + o.items[0].n : (isNaN(o.mesa) ? 'Venta Caja' : `Mesa ${o.mesa}`)}
                                </div>
                                <div class="text-[9px] ${isExpense ? 'text-red-400' : 'text-slate-400'} uppercase">
                                    ${isExpense ? 'Salida de efectivo' : `${o.method} • ${o.items.length} prod`}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-right text-xs font-black font-mono ${isExpense ? 'text-red-600' : 'text-slate-800'}">
                                ${isExpense ? '-' : ''}${UI.format(o.total)}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="LOGIC.adminEdit('${o.id}', ${o.total})" class="text-blue-400 hover:text-blue-600 text-sm mx-1 p-1 hover:bg-blue-50 rounded" title="Ajustar Total"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button onclick="LOGIC.adminDel('${o.id}')" class="text-slate-300 hover:text-red-500 text-sm mx-1 p-1 hover:bg-red-50 rounded" title="Eliminar Registro"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>`;
                    }).join('') || `<tr><td colspan="3" class="text-center py-6 text-xs text-slate-400">Sin movimientos</td></tr>`;
                }
            },
            
            cajaTab: (t) => {
                const act=t==='active'; document.getElementById('p-active').classList.toggle('hidden',!act); document.getElementById('p-report').classList.toggle('hidden',act);
                document.getElementById('btn-tab-act').classList.toggle('border-brand-accent',act); document.getElementById('btn-tab-act').classList.toggle('text-brand-accent',act); document.getElementById('btn-tab-act').classList.toggle('border-transparent',!act);
                document.getElementById('btn-tab-rep').classList.toggle('border-brand-accent',!act); document.getElementById('btn-tab-rep').classList.toggle('text-brand-accent',!act); document.getElementById('btn-tab-rep').classList.toggle('border-transparent',act);
            },
            
            // Selección de items para cobro parcial
            selectedItems: [],
            orderItems: [],
            
            toggleItemSelect: (idx) => {
                const checkbox = document.getElementById(`pay-item-${idx}`);
                if(checkbox.checked) {
                    if(!UI.selectedItems.includes(idx)) UI.selectedItems.push(idx);
                } else {
                    UI.selectedItems = UI.selectedItems.filter(i => i !== idx);
                }
                UI.updatePayTotal();
            },
            
            toggleAllItems: () => {
                const allSelected = UI.selectedItems.length === UI.orderItems.length;
                UI.selectedItems = allSelected ? [] : UI.orderItems.map((_, idx) => idx);
                UI.orderItems.forEach((_, idx) => {
                    document.getElementById(`pay-item-${idx}`).checked = !allSelected;
                });
                UI.updatePayTotal();
            },
            
            updatePayTotal: () => {
                let total = 0;
                UI.selectedItems.forEach(idx => {
                    const item = UI.orderItems[idx];
                    if(item) total += item.p * item.qty;
                });
                document.getElementById('pay-amount-label').innerText = UI.format(total);
                document.getElementById('pay-items-count').innerText = `${UI.selectedItems.length} artículo${UI.selectedItems.length !== 1 ? 's' : ''} seleccionado${UI.selectedItems.length !== 1 ? 's' : ''}`;
                STATE.payData.selectedTotal = total;
            },
            
            // Modal para editar items de una orden
            modalEditItems: (orderId) => {
                const order = STATE.orders.find(o => o.id === orderId);
                if(!order) return UI.toast('Orden no encontrada', 'error');
                
                const el = document.getElementById('modal-edit-items');
                document.getElementById('edit-mesa-label').innerText = isNaN(order.mesa) ? 'LLEVAR' : `Mesa ${order.mesa}`;
                document.getElementById('edit-order-id').innerText = '#' + orderId.slice(0,4);
                
                document.getElementById('edit-items-list').innerHTML = order.items.map((item, idx) => `
                    <div class="flex items-center gap-2 p-2.5 bg-white rounded-xl border border-slate-100 group hover:border-red-200 transition-all">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-slate-700 font-medium truncate">${item.n}</p>
                            <p class="text-[10px] text-slate-400">${UI.format(item.p)} x ${item.qty} = <span class="font-bold text-slate-600">${UI.format(item.p * item.qty)}</span></p>
                        </div>
                        <button onclick="LOGIC.removeOrderItem('${orderId}', ${idx})" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-400 hover:bg-red-100 hover:text-red-600 flex items-center justify-center transition-all tap-effect opacity-60 group-hover:opacity-100">
                            <i class="fa-solid fa-trash-can text-xs"></i>
                        </button>
                    </div>
                `).join('') || '<p class="text-center text-slate-400 text-xs py-4">Sin artículos</p>';
                
                document.getElementById('edit-total-label').innerText = UI.format(order.total);
                
                el.classList.remove('hidden');
                el.classList.add('flex');
            },
            
            closeEditModal: () => {
                const el = document.getElementById('modal-edit-items');
                el.classList.add('hidden');
                el.classList.remove('flex');
            },
            
            modalPay: (show, id, mesa, amt) => {
                const el=document.getElementById('modal-pay'); 
                if(show){
                    const order = STATE.orders.find(o => o.id === id);
                    UI.orderItems = order ? [...order.items] : [];
                    UI.selectedItems = UI.orderItems.map((_, idx) => idx); // Seleccionar todos por defecto
                    
                    STATE.payData={id, mesa, amt, selectedTotal: amt}; 
                    document.getElementById('pay-mesa-label').innerText=isNaN(mesa)?'LLEVAR':`Mesa ${mesa}`; 
                    
                    // Renderizar lista de items
                    document.getElementById('pay-items-list').innerHTML = UI.orderItems.map((item, idx) => `
                        <label class="flex items-center gap-2 p-2 bg-white rounded-xl border border-slate-100 cursor-pointer hover:border-green-300 transition-all tap-effect">
                            <input type="checkbox" id="pay-item-${idx}" onchange="UI.toggleItemSelect(${idx})" checked class="w-4 h-4 accent-green-500 rounded">
                            <span class="flex-1 text-xs text-slate-700 font-medium truncate">${item.n}</span>
                            <span class="text-[10px] text-slate-400 font-bold bg-slate-100 px-1.5 py-0.5 rounded">x${item.qty}</span>
                            <span class="text-xs text-slate-800 font-bold">${UI.format(item.p * item.qty)}</span>
                        </label>
                    `).join('') || '<p class="text-center text-slate-400 text-xs py-4">Sin artículos</p>';
                    
                    UI.updatePayTotal();
                    el.classList.remove('hidden'); 
                    el.classList.add('flex'); 
                    document.querySelectorAll('.pay-btn').forEach(b=>{b.disabled=false; b.querySelector('.content').style.display='flex'; if(b.querySelector('.sp'))b.querySelector('.sp').remove();});
                }else{
                    el.classList.add('hidden'); 
                    el.classList.remove('flex');
                }
            },

            // --- MOTOR DE REPORTES PDF PROFESIONAL ---
            generatePDF: async () => {
                try {
                    if(!STATE.reportSummary || STATE.reportSummary.history.length === 0) return UI.toast('No hay ventas registradas.', 'error');
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const d = new Date();
                    const fechaStr = d.toLocaleDateString('es-MX', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const horaStr = d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                    
                    // Cálculos financieros
                    const fondo = STATE.cashFund || 0;
                    const ventasTotal = STATE.reportSummary.total || 0;
                    const efectivo = STATE.reportSummary.cash || 0;
                    const tarjeta = STATE.reportSummary.card || 0;
                    const gastos = STATE.reportSummary.gastos || 0;
                    const efectivoEnCaja = fondo + efectivo - gastos;
                    const numTransacciones = STATE.reportSummary.history.length;
                    const numGastos = STATE.reportSummary.expenses?.length || 0;
                    const ticketPromedio = numTransacciones > 0 ? ventasTotal / numTransacciones : 0;
                    
                    // Colores corporativos
                    const naranja = [249, 115, 22];
                    const oscuro = [15, 23, 42];
                    const gris = [100, 116, 139];
                    const verde = [34, 197, 94];
                    const rojo = [239, 68, 68];
                    
                    // ========== ENCABEZADO ==========
                    // Barra lateral decorativa
                    doc.setFillColor(...naranja);
                    doc.rect(0, 0, 8, 297, 'F');
                    
                    // Logo y nombre del negocio
                    doc.setFillColor(...oscuro);
                    doc.roundedRect(15, 10, 180, 35, 3, 3, 'F');
                    
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.text("LA CABAÑA", 25, 27);
                    doc.setFontSize(10);
                    doc.setTextColor(200, 200, 200);
                    doc.text("DE LA PROGRESO MENUDERÍA", 25, 35);
                    
                    // Info de contacto
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text("Benito Juárez 20, Progreso, 21325 Mexicali, B.C.", 110, 27);
                    doc.text("Tel: (686) XXX-XXXX", 110, 33);
                    
                    // Título del reporte
                    doc.setTextColor(...oscuro);
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("CORTE DE CAJA", 15, 58);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(...gris);
                    doc.text(`Folio: #${d.getTime().toString().slice(-8)}`, 15, 65);
                    
                    // Fecha y hora
                    doc.setFontSize(9);
                    doc.text(fechaStr.charAt(0).toUpperCase() + fechaStr.slice(1), 110, 58);
                    doc.text(`Hora de corte: ${horaStr}`, 110, 65);
                    
                    // Línea separadora
                    doc.setDrawColor(...naranja);
                    doc.setLineWidth(0.5);
                    doc.line(15, 70, 195, 70);
                    
                    // ========== RESUMEN FINANCIERO ==========
                    doc.setFontSize(11);
                    doc.setTextColor(...oscuro);
                    doc.setFont("helvetica", "bold");
                    doc.text("RESUMEN FINANCIERO", 15, 80);
                    
                    // Tarjetas de resumen
                    const cardY = 85;
                    const cardH = 25;
                    const cardW = 35;
                    
                    // Card 1: Fondo
                    doc.setFillColor(241, 245, 249);
                    doc.roundedRect(15, cardY, cardW, cardH, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(...gris);
                    doc.text("FONDO INICIAL", 17, cardY + 7);
                    doc.setFontSize(11);
                    doc.setTextColor(...oscuro);
                    doc.setFont("helvetica", "bold");
                    doc.text(UI.format(fondo), 17, cardY + 16);
                    
                    // Card 2: Ventas
                    doc.setFillColor(254, 243, 199);
                    doc.roundedRect(53, cardY, cardW, cardH, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(...gris);
                    doc.text("VENTAS TOTALES", 55, cardY + 7);
                    doc.setFontSize(11);
                    doc.setTextColor(...naranja);
                    doc.setFont("helvetica", "bold");
                    doc.text(UI.format(ventasTotal), 55, cardY + 16);
                    
                    // Card 3: Efectivo
                    doc.setFillColor(220, 252, 231);
                    doc.roundedRect(91, cardY, cardW, cardH, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(...gris);
                    doc.text("EFECTIVO", 93, cardY + 7);
                    doc.setFontSize(11);
                    doc.setTextColor(...verde);
                    doc.setFont("helvetica", "bold");
                    doc.text(UI.format(efectivo), 93, cardY + 16);
                    
                    // Card 4: Tarjeta
                    doc.setFillColor(219, 234, 254);
                    doc.roundedRect(129, cardY, cardW, cardH, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(...gris);
                    doc.text("TARJETA", 131, cardY + 7);
                    doc.setFontSize(11);
                    doc.setTextColor(59, 130, 246);
                    doc.setFont("helvetica", "bold");
                    doc.text(UI.format(tarjeta), 131, cardY + 16);
                    
                    // Card 5: Gastos
                    doc.setFillColor(254, 226, 226);
                    doc.roundedRect(167, cardY, 28, cardH, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(...gris);
                    doc.text("GASTOS", 169, cardY + 7);
                    doc.setFontSize(11);
                    doc.setTextColor(...rojo);
                    doc.setFont("helvetica", "bold");
                    doc.text("-" + UI.format(gastos), 169, cardY + 16);
                    
                    // ========== TOTAL EN CAJA (DESTACADO) ==========
                    doc.setFillColor(...oscuro);
                    doc.roundedRect(15, 115, 180, 20, 3, 3, 'F');
                    doc.setFontSize(10);
                    doc.setTextColor(200, 200, 200);
                    doc.text("EFECTIVO TOTAL EN CAJA", 20, 126);
                    doc.setFontSize(16);
                    doc.setTextColor(255, 255, 255);
                    doc.setFont("helvetica", "bold");
                    doc.text(UI.format(efectivoEnCaja), 140, 128);
                    
                    // ========== ESTADÍSTICAS ==========
                    doc.setFontSize(9);
                    doc.setTextColor(...gris);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Transacciones: ${numTransacciones}  |  Gastos registrados: ${numGastos}  |  Ticket promedio: ${UI.format(ticketPromedio)}`, 15, 145);
                    
                    // ========== MIX DE VENTAS ==========
                    doc.setFontSize(11);
                    doc.setTextColor(...oscuro);
                    doc.setFont("helvetica", "bold");
                    doc.text("DESGLOSE DE PRODUCTOS VENDIDOS", 15, 155);
                    
                    let pRows = Object.entries(STATE.reportSummary.items)
                        .sort((a,b) => b[1].s - a[1].s)
                        .map(([n, v], idx) => [idx + 1, n.toUpperCase(), v.q, UI.format(v.s)]);
                    
                    doc.autoTable({
                        startY: 160,
                        margin: { left: 15, right: 15 },
                        head: [['#', 'PRODUCTO', 'CANTIDAD', 'SUBTOTAL']],
                        body: pRows,
                        theme: 'striped',
                        headStyles: { 
                            fillColor: naranja, 
                            textColor: 255, 
                            fontStyle: 'bold',
                            fontSize: 8
                        },
                        bodyStyles: { fontSize: 8 },
                        columnStyles: { 
                            0: { cellWidth: 10, halign: 'center' },
                            1: { cellWidth: 'auto' },
                            2: { cellWidth: 25, halign: 'center' },
                            3: { cellWidth: 30, halign: 'right' }
                        },
                        alternateRowStyles: { fillColor: [248, 250, 252] }
                    });
                    
                    // ========== HISTORIAL DE TRANSACCIONES ==========
                    let yPos = doc.lastAutoTable.finalY + 10;
                    
                    // Verificar si necesitamos nueva página
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(11);
                    doc.setTextColor(...oscuro);
                    doc.setFont("helvetica", "bold");
                    doc.text("HISTORIAL DE TRANSACCIONES", 15, yPos);
                    
                    let tRows = STATE.reportSummary.history.map((h, idx) => {
                        const hora = h.ts?.seconds ? new Date(h.ts.seconds * 1000).toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'}) : '--:--';
                        const mesa = isNaN(h.mesa) ? h.mesa : `Mesa ${h.mesa}`;
                        return [idx + 1, hora, mesa, h.method?.toUpperCase() || 'N/A', UI.format(h.total)];
                    });
                    
                    doc.autoTable({
                        startY: yPos + 5,
                        margin: { left: 15, right: 15 },
                        head: [['#', 'HORA', 'REFERENCIA', 'MÉTODO', 'MONTO']],
                        body: tRows,
                        theme: 'grid',
                        headStyles: { 
                            fillColor: oscuro, 
                            textColor: 255, 
                            fontStyle: 'bold',
                            fontSize: 8
                        },
                        bodyStyles: { fontSize: 8 },
                        columnStyles: { 
                            0: { cellWidth: 10, halign: 'center' },
                            1: { cellWidth: 20, halign: 'center' },
                            2: { cellWidth: 'auto' },
                            3: { cellWidth: 25, halign: 'center' },
                            4: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                        }
                    });
                    
                    // ========== GASTOS (si hay) ==========
                    if (STATE.reportSummary.expenses && STATE.reportSummary.expenses.length > 0) {
                        yPos = doc.lastAutoTable.finalY + 10;
                        
                        if (yPos > 250) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFontSize(11);
                        doc.setTextColor(...rojo);
                        doc.setFont("helvetica", "bold");
                        doc.text("GASTOS OPERATIVOS", 15, yPos);
                        
                        let gRows = STATE.reportSummary.expenses.map((e, idx) => {
                            const hora = e.ts?.seconds ? new Date(e.ts.seconds * 1000).toLocaleTimeString('es-MX', {hour: '2-digit', minute: '2-digit'}) : '--:--';
                            return [idx + 1, hora, e.items[0]?.n || 'Gasto', "-" + UI.format(e.total)];
                        });
                        
                        doc.autoTable({
                            startY: yPos + 5,
                            margin: { left: 15, right: 15 },
                            head: [['#', 'HORA', 'DESCRIPCIÓN', 'MONTO']],
                            body: gRows,
                            theme: 'grid',
                            headStyles: { 
                                fillColor: rojo, 
                                textColor: 255, 
                                fontStyle: 'bold',
                                fontSize: 8
                            },
                            bodyStyles: { fontSize: 8, textColor: rojo },
                            columnStyles: { 
                                0: { cellWidth: 10, halign: 'center' },
                                1: { cellWidth: 20, halign: 'center' },
                                2: { cellWidth: 'auto' },
                                3: { cellWidth: 30, halign: 'right', fontStyle: 'bold' }
                            }
                        });
                    }
                    
                    // ========== PIE DE PÁGINA ==========
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        
                        // Línea de pie
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.3);
                        doc.line(15, 280, 195, 280);
                        
                        // Texto de pie
                        doc.setFontSize(8);
                        doc.setTextColor(...gris);
                        doc.setFont("helvetica", "normal");
                        doc.text("La Cabaña de la Progreso - Sistema POS", 15, 287);
                        doc.text(`Página ${i} de ${pageCount}`, 175, 287);
                        doc.text(`Generado: ${d.toLocaleString('es-MX')}`, 85, 287);
                    }
                    
                    doc.save(`Corte_LaCabana_${d.toISOString().slice(0,10)}.pdf`);
                    UI.toast("PDF Generado exitosamente", 'success');
                } catch (e) { 
                    console.error(e); 
                    UI.toast("Error al generar PDF", 'error'); 
                }
            }
        };

        window.LOGIC = {
            cartAdd: (n,p) => { if(window.navigator.vibrate)window.navigator.vibrate(15); const x=STATE.cart.find(i=>i.n===n); if(x)x.qty++; else STATE.cart.push({n,p,qty:1,note:''}); UI.renderCart(); UI.toast('Agregado','success'); },
            cartUpd: (i,d) => { STATE.cart[i].qty+=d; if(STATE.cart[i].qty<=0)STATE.cart.splice(i,1); UI.renderCart(); },
            cartNote: (i) => { const nt=prompt('Nota cocina:',STATE.cart[i].note); if(nt!==null){STATE.cart[i].note=nt;UI.renderCart();} },
            
            // PLATILLO ESPECIAL / PRECIO MANUAL
            addSpecialItem: () => {
                const nombre = prompt('✨ Nombre del platillo especial:');
                if(!nombre || nombre.trim() === '') return;
                
                const precioStr = prompt(`💰 Precio para "${nombre}" ($):`);
                const precio = parseFloat(precioStr);
                
                if(!precio || precio <= 0) {
                    return UI.toast('Precio inválido', 'error');
                }
                
                // Agregar al carrito como item especial
                STATE.cart.push({
                    n: '⭐ ' + nombre.trim(),
                    p: precio,
                    qty: 1,
                    note: 'ESPECIAL',
                    isSpecial: true
                });
                
                UI.renderCart();
                UI.toast(`"${nombre}" agregado a $${precio.toFixed(2)}`, 'success');
                
                if(window.navigator.vibrate) window.navigator.vibrate([50, 30, 50]);
            },
            
            sendOrder: async (btn) => {
                const m = document.getElementById('sel-mesa').value; if(!m || !STATE.cart.length) return UI.toast('Mesa o Carrito Vacío','error');
                btn.disabled=true; const html=btn.innerHTML; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin text-xl"></i> Enviando...';
                try {
                    const tot = STATE.cart.reduce((a,b)=>a+(b.p*b.qty),0);
                    const esLlevar = isNaN(parseInt(m)); // Detectar si es para llevar (no es número)
                    
                    // Buscar orden principal abierta (excluir tickets de cocina) - SOLO si NO es para llevar
                    const open = !esLlevar ? STATE.orders.find(o=>o.mesa==m && o.status!=='pagado' && !o.isKitchenTicket) : null;
                    
                    if(open){ 
                        // Actualizar orden principal con TODOS los items (para caja)
                        await updateDoc(doc(ORDERS_COL, open.id), { items:[...open.items,...STATE.cart], total:open.total+tot });
                        // Crear ticket de cocina SOLO con los nuevos productos
                        await addDoc(ORDERS_COL,{mesa:m, items:STATE.cart, total:tot, status:'en_cocina', ts:serverTimestamp(), method:'', isKitchenTicket:true, parentOrder:open.id}); 
                        UI.toast('Agregado a Mesa '+m,'success'); 
                    }
                    else { 
                        // Crear nueva orden (siempre para LLEVAR, o si no hay orden abierta)
                        await addDoc(ORDERS_COL,{mesa:m, items:STATE.cart, total:tot, status:'en_cocina', ts:serverTimestamp(), method:''}); 
                        UI.toast(esLlevar ? 'Pedido LLEVAR enviado' : 'Enviado','success'); 
                    }
                    STATE.cart=[]; UI.renderCart(); UI.toggleCartMobile(false); document.getElementById('sel-mesa').value='';
                } catch(e){ console.error(e); UI.toast('Error envío','error'); } finally { btn.disabled=false; btn.innerHTML=html; }
            },
            statusUpd: async (id,s) => { 
                try{
                    const order = STATE.orders.find(o => o.id === id);
                    await updateDoc(doc(ORDERS_COL,id),{status:s}); 
                    // Si es un ticket de cocina adicional y se marca como entregado, también actualizar la orden principal
                    if(order && order.isKitchenTicket && order.parentOrder && s === 'en_mesa') {
                        const parent = STATE.orders.find(o => o.id === order.parentOrder);
                        // Si no hay más tickets pendientes de cocina para esta mesa, marcar orden principal como en_mesa
                        const pendingTickets = STATE.orders.filter(o => o.parentOrder === order.parentOrder && o.status === 'en_cocina' && o.id !== id);
                        if(pendingTickets.length === 0 && parent) {
                            await updateDoc(doc(ORDERS_COL, order.parentOrder), {status: 'en_mesa'});
                        }
                    }
                    UI.toast('Estatus Cambiado');
                }catch{UI.toast('Error','error');} 
            },
            processPayment: async (mt,btn) => {
                if(UI.selectedItems.length === 0) {
                    UI.toast('Selecciona al menos un artículo', 'error');
                    return;
                }
                
                const sp=document.createElement('div'); sp.className='sp flex flex-col items-center gap-1 mt-1 text-slate-400'; sp.innerHTML='<i class="fa-solid fa-spinner fa-spin text-xl"></i>';
                btn.disabled=true; btn.querySelector('.content').style.display='none'; btn.appendChild(sp);
                try { 
                    await new Promise(r=>setTimeout(r,600)); 
                    
                    const orderToPay = STATE.orders.find(o => o.id === STATE.payData.id);
                    const selectedItemsData = UI.selectedItems.map(idx => UI.orderItems[idx]);
                    const selectedTotal = STATE.payData.selectedTotal;
                    
                    // Verificar si se cobran todos los items o solo algunos
                    const allItemsSelected = UI.selectedItems.length === UI.orderItems.length;
                    
                    if(allItemsSelected) {
                        // Cobro total - marcar orden como pagada
                        await updateDoc(doc(ORDERS_COL,STATE.payData.id),{status:'pagado', method:mt, ts:serverTimestamp()}); 
                        // Eliminar tickets de cocina asociados
                        const kitchenTickets = STATE.orders.filter(o => o.parentOrder === STATE.payData.id);
                        for(const ticket of kitchenTickets) {
                            await deleteDoc(doc(ORDERS_COL, ticket.id));
                        }
                    } else {
                        // Cobro parcial - crear nueva orden pagada con items seleccionados y actualizar orden original
                        const remainingItems = UI.orderItems.filter((_, idx) => !UI.selectedItems.includes(idx));
                        const remainingTotal = remainingItems.reduce((acc, i) => acc + (i.p * i.qty), 0);
                        
                        // Crear orden pagada con los items cobrados
                        await addDoc(ORDERS_COL, {
                            mesa: STATE.payData.mesa,
                            items: selectedItemsData,
                            total: selectedTotal,
                            status: 'pagado',
                            method: mt,
                            ts: serverTimestamp(),
                            isPartialPayment: true,
                            originalOrderId: STATE.payData.id
                        });
                        
                        // Actualizar orden original con items restantes
                        if(remainingItems.length > 0) {
                            await updateDoc(doc(ORDERS_COL, STATE.payData.id), {
                                items: remainingItems,
                                total: remainingTotal
                            });
                        } else {
                            // Si no quedan items, marcar como pagada
                            await updateDoc(doc(ORDERS_COL, STATE.payData.id), {status:'pagado', method:mt, ts:serverTimestamp()});
                            const kitchenTickets = STATE.orders.filter(o => o.parentOrder === STATE.payData.id);
                            for(const ticket of kitchenTickets) {
                                await deleteDoc(doc(ORDERS_COL, ticket.id));
                            }
                        }
                    }
                    
                    UI.modalPay(false); 
                    UI.toast('Cobro OK','success'); 
                } 
                catch(e){ UI.toast('Error Pago','error'); btn.disabled=false; btn.querySelector('.content').style.display='flex'; sp.remove(); }
            },
            manualSale: async () => { const d=prompt('Desc:'); if(!d)return; const p=parseFloat(prompt('Monto:')); if(!p)return; await addDoc(ORDERS_COL,{mesa:'CAJA',items:[{n:d,p:p,qty:1}],total:p,status:'pagado',method:'Efectivo',ts:serverTimestamp()}); UI.toast('Venta manual OK'); },
            addExpense: async () => { 
                const desc = prompt('Descripción del gasto:'); 
                if(!desc) return; 
                const monto = parseFloat(prompt('Monto del gasto ($):')); 
                if(!monto || monto <= 0) return UI.toast('Monto inválido', 'error'); 
                try {
                    await addDoc(ORDERS_COL, {
                        mesa: 'GASTO',
                        items: [{n: desc, p: monto, qty: 1}],
                        total: monto,
                        status: 'gasto',
                        method: 'Efectivo',
                        ts: serverTimestamp(),
                        isExpense: true
                    }); 
                    UI.toast('Gasto registrado: $' + monto.toFixed(2), 'success'); 
                } catch(e) { 
                    console.error(e); 
                    UI.toast('Error al registrar gasto', 'error'); 
                }
            },
            resetAll: async () => { if(confirm('⚠️ ¿BORRAR HISTORIAL? (Irreversible)')){ const b=writeBatch(db); STATE.orders.forEach(o=>b.delete(doc(ORDERS_COL,o.id))); await b.commit(); window.location.reload(); } },
            
            // ADMIN ACTIONS
            adminEdit: async (id, currTot) => {
                const n = parseFloat(prompt('Nuevo Total Correcto ($):', currTot));
                if(n && !isNaN(n) && n>=0){ try{await updateDoc(doc(ORDERS_COL, id), {total: n}); UI.toast('Monto Ajustado');}catch(e){UI.toast('Error','error');}}
            },
            adminDel: async (id) => {
                if(confirm('¿ELIMINAR registro permanentemente?')){ try{await deleteDoc(doc(ORDERS_COL, id)); UI.toast('Registro Borrado');}catch{UI.toast('Error','error');} }
            },
            removeOrderItem: async (orderId, itemIdx) => {
                if(!confirm('¿Eliminar este platillo de la orden?')) return;
                try {
                    const order = STATE.orders.find(o => o.id === orderId);
                    if(!order) return UI.toast('Orden no encontrada', 'error');
                    
                    const newItems = order.items.filter((_, idx) => idx !== itemIdx);
                    
                    if(newItems.length === 0) {
                        // Si no quedan items, eliminar la orden completa
                        if(confirm('No quedan platillos. ¿Eliminar toda la orden?')) {
                            await deleteDoc(doc(ORDERS_COL, orderId));
                            // Eliminar tickets de cocina asociados
                            const kitchenTickets = STATE.orders.filter(o => o.parentOrder === orderId);
                            for(const ticket of kitchenTickets) {
                                await deleteDoc(doc(ORDERS_COL, ticket.id));
                            }
                            UI.toast('Orden eliminada', 'success');
                        }
                    } else {
                        const newTotal = newItems.reduce((acc, i) => acc + (i.p * i.qty), 0);
                        await updateDoc(doc(ORDERS_COL, orderId), { items: newItems, total: newTotal });
                        UI.toast('Platillo eliminado', 'success');
                    }
                    
                    // Cerrar modal y refrescar
                    document.getElementById('modal-edit-items').classList.add('hidden');
                    document.getElementById('modal-edit-items').classList.remove('flex');
                } catch(e) {
                    console.error(e);
                    UI.toast('Error al eliminar', 'error');
                }
            }
        };

        window.APP = { setRole:(r)=>{STATE.role=r; document.getElementById('v-role').style.display='none'; document.getElementById('txt-role').innerText=r.toUpperCase(); document.querySelectorAll('main > div:not(#v-role)').forEach(d=>d.classList.add('hidden')); const v=document.getElementById(`v-${r}`); v.classList.remove('hidden'); v.classList.add('flex'); if(r==='mesero')UI.initMesero(); if(STATE.orders.length)UI.renderOrders();} };
        
        // TIMEOUT: Si no conecta en 5 segundos, quitar loader y mostrar aviso
        let firebaseConnected = false;
        setTimeout(() => {
            if(!firebaseConnected) {
                document.getElementById('app-loader').classList.add('opacity-0','pointer-events-none');
                document.getElementById('indicator-status').className="w-2.5 h-2.5 rounded-full bg-yellow-500 animate-pulse";
                document.getElementById('indicator-status').title="Conectando... (Sin conexión a servidor)";
                UI.toast('⚠️ Modo sin conexión - Conectando...', 'error');
            }
        }, 5000);
        
        onAuthStateChanged(auth, u=>{ if(u){ 
            firebaseConnected = true;
            document.getElementById('app-loader').classList.add('opacity-0','pointer-events-none');
            document.getElementById('indicator-status').className="w-2.5 h-2.5 rounded-full bg-green-500 shadow-glass";
            onSnapshot(query(ORDERS_COL),(s)=>{ 
                STATE.orders=s.docs.map(d=>({id:d.id,...d.data()})); 
                if(STATE.role)UI.renderOrders();
                // Notificación sonora para cocina cuando llega pedido nuevo
                if(STATE.role==='cocina') s.docChanges().forEach(c=>{ if(c.type==='added' && (Date.now()/1000 - c.doc.data().ts?.seconds)<30) UI.playSound(); });
            }); 
        } else signInAnonymously(auth).catch(e => {
            console.error('Error Firebase Auth:', e);
            document.getElementById('app-loader').classList.add('opacity-0','pointer-events-none');
            UI.toast('Error de conexión', 'error');
        }); });

        // Loop Visualizador Tiempo Cocina (Optimizado a 1 segundo para actualizar estilos en tiempo real)
        setInterval(() => UI.updateKitchenTimers(), 1000);

    </script>
</body>
</html>